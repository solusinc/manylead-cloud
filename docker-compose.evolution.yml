services:
  # Evolution API - WhatsApp Integration
  evolution-api:
    container_name: manylead-evolution-api
    image: evoapicloud/evolution-api:v2.3.6
    restart: always
    ports:
      - "8081:8080"  # Porta 8081 (Evolution) - diferente do server (3002)
    env_file:
      - .env.evolution
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    depends_on:
      evolution-postgres:
        condition: service_healthy
      evolution-redis:
        condition: service_started
    environment:
      - TZ=America/Sao_Paulo
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PostgreSQL - Evolution Database
  evolution-postgres:
    container_name: manylead-evolution-postgres
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_DB: evolution
      POSTGRES_USER: evolution
      POSTGRES_PASSWORD: 1c8429e10f64c0ebc3561b3dd8c59c4f4b3ea322733a3746
      POSTGRES_MAX_CONNECTIONS: 1000
    volumes:
      - evolution_postgres:/var/lib/postgresql/data
    ports:
      - "5433:5432"  # Porta 5433 (Evolution) - diferente do principal (5432)
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U evolution -d evolution"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis - Cache & Sessions
  evolution-redis:
    container_name: manylead-evolution-redis
    image: redis:7-alpine
    restart: always
    command: redis-server --appendonly yes --requirepass c2ad8899d63b3c01dedf93a4d7b972753e13c3a2ada8d76e
    volumes:
      - evolution_redis:/data
    ports:
      - "6380:6379"  # Porta 6380 (Evolution) - diferente do principal (6379)
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

volumes:
  evolution_instances:
  evolution_store:
  evolution_postgres:
  evolution_redis:
